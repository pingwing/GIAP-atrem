<!DOCTYPE html>
<html>
<head>
    <title>WFS OL3</title>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.13.1/css/ol.css" type="text/css">
    <script src="jquery.min.js">//https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js</script>
    <script src="ol-debug.js" type="text/javascript">//http://openlayers.org/en/v3.13.1/build/ol-debug.js</script>
    <script src="underscore.js" type="text/javascript">//http://underscorejs.org/underscore-min.js</script>
</head>
<body>
<DIV id="map" class="map"></DIV>

<DIV id="customControl" onload="initWFSTransactions()">
    <input type="button" id="customControlDelete" value="delete"/>
    <input type="button" id="customControlSave" value="save"/>
</DIV>

<script type="text/javascript">
    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.OSM()
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([20.03, 49.477778]),
            zoom: 17
        })
    });

    var vectorSource = new ol.source.Vector({
        format: new ol.format.GeoJSON(),
        url: function (extent) {
            return 'http://uslugi.giap.pl/geoserver/wfs?service=WFS&' +
                    'version=1.1.0&request=GetFeature&typename=nowy_targ:dzialki&' +
                    'outputFormat=application/json&srsname=EPSG:3857&' +
                    'bbox=' + extent.join(',') + ',EPSG:3857';
        },
        strategy: ol.loadingstrategy.tile(ol.tilegrid.createXYZ({
            maxZoom: 19
        }))
    });

    var vector = new ol.layer.Vector({
        source: vectorSource,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'rgba(0, 0, 255, 1.0)',
                width: 2
            })
        })
    });

    map.addLayer(vector);

    var featuresToInsert = [];
    var featuresToUpdateObject = {};
    var featuresToDelete = [];

    var selectFeat = new ol.interaction.Select();
    map.addInteraction(selectFeat);
    var selectedFeat = selectFeat.getFeatures();

    var modifyFeat = new ol.interaction.Modify({
        features: selectedFeat,
        deleteCondition: function(event) {
            return ol.events.condition.shiftKeyOnly(event) &&
                    ol.events.condition.singleClick(event);
        }
    });
    map.addInteraction(modifyFeat);
    modifyFeat.on('modifyend', modifiedFeatures);

    function deleteFeatures() {
        if (selectedFeat.getLength() > 0) {
            console.log('PINGWIN: selectedFeat.getArray()', selectedFeat.getArray());
            _.each(selectedFeat.getArray(), function(toDeleteFeat) {
                console.log('PINGWIN: toDeleteFeat', toDeleteFeat);
                vectorSource.removeFeature(toDeleteFeat);
                featuresToDelete.push(toDeleteFeat);
            });
            selectedFeat.clear();
        }
        else
            window.alert("Wybierz najpierw obiekt do usuniÄ™cia");
        console.log('PINGWIN: featuresToDelete', featuresToDelete);
    }

    function modifiedFeatures(event) {
        console.log('PINGWIN: in modifiedFeatures');
        var modifiedFeatures = event.features.getArray();
        if (event.features.getLength() > 0) {
            _.each(modifiedFeatures, function(modifiedFeat) {
                var modifiedFeatureId = modifiedFeat.id_;
                console.log('PINGWIN: modifiedFeat.getGeometry()', modifiedFeat.getGeometry());
                console.log('PINGWIN: modifiedFeat.getGeometryName()', modifiedFeat.getGeometryName());
                var geometryInMapCRS = modifiedFeat.getGeometry();
                console.log('PINGWIN: geometryInMapCRS', geometryInMapCRS);
                var geometryIn2180 = ol.proj.transform(geometryInMapCRS, 'EPSG:3857', 'EPSG:2180');
                modifiedFeat.set('the_geom', geometryIn2180);
                //modifiedFeat.setGeometryName('the_geom');
                console.log('PINGWIN: modifiedFeat.getGeometry()', modifiedFeat.getGeometry());

                featuresToUpdateObject[modifiedFeatureId] = modifiedFeat;
            });
        }
        console.log('PINGWIN: featuresToUpdateObject', featuresToUpdateObject);
    }

    $('#customControlDelete').on('click', function () {
        deleteFeatures();
    });

    $('#customControlSave').on('click', function () {
        transactWFS();
        featuresToInsert = [];
        featuresToUpdateObject = {};
        featuresToDelete = [];
    });

    var formatWFS = new ol.format.WFS();
    var formatGML = new ol.format.GML({
        featureNS: 'nowy_targ',
        featureType: 'dzialki',
        srsName: 'EPSG:2180'
    });

    function removeLowerCaseGeometryNodeForInsert(node)
    {

        var geometryNodes = node.getElementsByTagName("geometry"), element;
        while (geometryNode = geometryNodes[0])
        {
            geometryNode.parentNode.removeChild(geometryNode);
        }

    }

    function removeNodeForWfsUpdate(node, valueToRemove)
    {
        var propNodes = node.getElementsByTagName("Property");
        for (var i = 0; i < propNodes.length; i++)
        {
            var propNode = propNodes[i];
            var propNameNode = propNode.firstElementChild;
            var propNameNodeValue = propNameNode.firstChild;
            if (propNameNodeValue.nodeValue === valueToRemove)
            {
                propNode.parentNode.removeChild(propNode);
                break;
            }
        }
    }

    var transactWFS = function () {
        var featuresToUpdate = _.values(featuresToUpdateObject);
        
        console.log('PINGWIN: w transactWFS');
        console.log('PINGWIN: featuresToInsert', featuresToInsert);
        console.log('PINGWIN: featuresToUpdate', featuresToUpdate);
        console.log('PINGWIN: featuresToDelete', featuresToDelete);

        var node = formatWFS.writeTransaction(featuresToInsert, featuresToUpdate, featuresToDelete, formatGML);

        removeLowerCaseGeometryNodeForInsert(node);
        removeNodeForWfsUpdate(node, "geometry");

        var s = new XMLSerializer();
        var str = s.serializeToString(node);
        $.ajax('http://uslugi.giap.pl/geoserver/wfs', {
            type: 'POST',
            dataType: 'xml',
            processData: false,
            contentType: 'text/xml',
            data: str
        }).done();
    };
    
    /*var deleteFeature = function () {
        selectFeat.getFeatures().on('change:length', function (e) {
            transactWFS('delete', e.target.item(0));
        });
    }*/
</script>

</body>
</html>